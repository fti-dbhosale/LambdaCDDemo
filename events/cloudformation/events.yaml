AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31
Description: >
  Setting thermal-events
Globals:
  Function:
    Runtime: !Ref PythonRuntime
    MemorySize: 256
    Timeout: 15
    CodeUri:
      Bucket: !Ref LambdaCodeS3Bucket
      Key: !Ref LambdaCodeS3Key

Resources:
  EventTable:
    Type: 'AWS::DynamoDB::Table'
    Properties:
      TableName: !Join
        - ''
        - - Events-
          - !Ref RealmName
      AttributeDefinitions:
        - AttributeName: EventID
          AttributeType: S
        - AttributeName: EventDate
          AttributeType: S
        - AttributeName: userID-eventCategory-zoneID
          AttributeType: S
        - AttributeName: userID-eventCategory-personID
          AttributeType: S
        - AttributeName: userID-eventCategory-eventType
          AttributeType: S
        - AttributeName: userID-eventCategory-zoneID-eventType
          AttributeType: S
      KeySchema:
        - AttributeName: EventID
          KeyType: HASH
        - AttributeName: EventDate
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: userID-eventCategory-zoneID-GSI
          KeySchema:
            - AttributeName: userID-eventCategory-zoneID
              KeyType: HASH
            - AttributeName: EventDate
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 50
            WriteCapacityUnits: 10
        - IndexName: userID-eventCategory-personID-GSI
          KeySchema:
            - AttributeName: userID-eventCategory-personID
              KeyType: HASH
            - AttributeName: EventDate
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 50
            WriteCapacityUnits: 10
        - IndexName: userID-eventCategory-eventType-EventDate-index
          KeySchema:
            - AttributeName: userID-eventCategory-eventType
              KeyType: HASH
            - AttributeName: EventDate
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 50
            WriteCapacityUnits: 10
        - IndexName: userID-eventCategory-zoneID-eventType-EventDate-index
          KeySchema:
            - AttributeName: userID-eventCategory-zoneID-eventType
              KeyType: HASH
            - AttributeName: EventDate
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 50
            WriteCapacityUnits: 10
      ProvisionedThroughput:
        ReadCapacityUnits: 50
        WriteCapacityUnits: 50
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      TimeToLiveSpecification:
        AttributeName: TTL
        Enabled: true

  EventTableWriteCapacityScalableTarget:
    Type: "AWS::ApplicationAutoScaling::ScalableTarget"
    Properties:
      MaxCapacity: 10000
      MinCapacity: 50
      ResourceId:
        "Fn::Join":
          - "/"
          - - table
            - Ref: EventTable
      RoleARN: !GetAtt AutoScalingDynamoDBRole.Arn
      ScalableDimension: "dynamodb:table:WriteCapacityUnits"
      ServiceNamespace: dynamodb

  EventTableWriteScalingPolicy:
    Type: "AWS::ApplicationAutoScaling::ScalingPolicy"
    Properties:
      PolicyName: EventTableWriteAutoScalingPolicy
      PolicyType: TargetTrackingScaling
      ScalingTargetId:
        Ref: EventTableWriteCapacityScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: 40
        ScaleInCooldown: 60
        ScaleOutCooldown: 60
        PredefinedMetricSpecification:
          PredefinedMetricType: DynamoDBWriteCapacityUtilization

  EventTableReadCapacityScalableTarget:
    Type: "AWS::ApplicationAutoScaling::ScalableTarget"
    Properties:
      MaxCapacity: 10000
      MinCapacity: 50
      ResourceId:
        "Fn::Join":
          - "/"
          - - table
            - Ref: EventTable
      RoleARN: !GetAtt AutoScalingDynamoDBRole.Arn
      ScalableDimension: "dynamodb:table:ReadCapacityUnits"
      ServiceNamespace: dynamodb

  EventTableReadScalingPolicy:
    Type: "AWS::ApplicationAutoScaling::ScalingPolicy"
    Properties:
      PolicyName: EventTableReadAutoScalingPolicy
      PolicyType: TargetTrackingScaling
      ScalingTargetId:
        Ref: EventTableReadCapacityScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: 40
        ScaleInCooldown: 60
        ScaleOutCooldown: 60
        PredefinedMetricSpecification:
          PredefinedMetricType: DynamoDBReadCapacityUtilization

  EventTableUserIDEventCategoryZoneIDEventTypeEventDateIndexWriteCapacityScalableTarget:
    Type: "AWS::ApplicationAutoScaling::ScalableTarget"
    Properties:
      MaxCapacity: 10000
      MinCapacity: 10
      ResourceId:
        "Fn::Join":
          - "/"
          - - table
            - Ref: EventTable
            - index
            - userID-eventCategory-zoneID-eventType-EventDate-index
      RoleARN: !GetAtt AutoScalingDynamoDBRole.Arn
      ScalableDimension: "dynamodb:index:WriteCapacityUnits"
      ServiceNamespace: dynamodb

  EventTableUserIDEventCategoryZoneIDEventTypeEventDateIndexWriteScalingPolicy:
    Type: "AWS::ApplicationAutoScaling::ScalingPolicy"
    Properties:
      PolicyName: EventTableUserIDEventCategoryZoneIDEventTypeEventDateIndexWriteScalingPolicy
      PolicyType: TargetTrackingScaling
      ScalingTargetId:
        Ref: EventTableUserIDEventCategoryZoneIDEventTypeEventDateIndexWriteCapacityScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: 40
        ScaleInCooldown: 60
        ScaleOutCooldown: 60
        PredefinedMetricSpecification:
          PredefinedMetricType: DynamoDBWriteCapacityUtilization

  EventTableUserIDEventCategoryZoneIDEventTypeEventDateIndexReadCapacityScalableTarget:
    Type: "AWS::ApplicationAutoScaling::ScalableTarget"
    Properties:
      MaxCapacity: 10000
      MinCapacity: 50
      ResourceId:
        "Fn::Join":
          - "/"
          - - table
            - Ref: EventTable
            - index
            - userID-eventCategory-zoneID-eventType-EventDate-index
      RoleARN: !GetAtt AutoScalingDynamoDBRole.Arn
      ScalableDimension: "dynamodb:index:ReadCapacityUnits"
      ServiceNamespace: dynamodb

  EventTableUserIDEventCategoryZoneIDEventTypeEventDateIndexReadScalingPolicy:
    Type: "AWS::ApplicationAutoScaling::ScalingPolicy"
    Properties:
      PolicyName: EventTableUserIDEventCategoryZoneIDEventTypeEventDateIndexReadScalingPolicy
      PolicyType: TargetTrackingScaling
      ScalingTargetId:
        Ref: EventTableUserIDEventCategoryZoneIDEventTypeEventDateIndexReadCapacityScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: 40
        ScaleInCooldown: 60
        ScaleOutCooldown: 60
        PredefinedMetricSpecification:
          PredefinedMetricType: DynamoDBReadCapacityUtilization

  EventTableUserIDEventCategoryEventTypeEventDateIndexWriteCapacityScalableTarget:
    Type: "AWS::ApplicationAutoScaling::ScalableTarget"
    Properties:
      MaxCapacity: 10000
      MinCapacity: 10
      ResourceId:
        "Fn::Join":
          - "/"
          - - table
            - Ref: EventTable
            - index
            - userID-eventCategory-eventType-EventDate-index
      RoleARN: !GetAtt AutoScalingDynamoDBRole.Arn
      ScalableDimension: "dynamodb:index:WriteCapacityUnits"
      ServiceNamespace: dynamodb

  EventTableUserIDEventCategoryEventTypeEventDateIndexWriteScalingPolicy:
    Type: "AWS::ApplicationAutoScaling::ScalingPolicy"
    Properties:
      PolicyName: EventTableUserIDEventCategoryEventTypeEventDateIndexWriteScalingPolicy
      PolicyType: TargetTrackingScaling
      ScalingTargetId:
        Ref: EventTableUserIDEventCategoryEventTypeEventDateIndexWriteCapacityScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: 40
        ScaleInCooldown: 60
        ScaleOutCooldown: 60
        PredefinedMetricSpecification:
          PredefinedMetricType: DynamoDBWriteCapacityUtilization

  EventTableUserIDEventCategoryEventTypeEventDateIndexReadCapacityScalableTarget:
    Type: "AWS::ApplicationAutoScaling::ScalableTarget"
    Properties:
      MaxCapacity: 10000
      MinCapacity: 50
      ResourceId:
        "Fn::Join":
          - "/"
          - - table
            - Ref: EventTable
            - index
            - userID-eventCategory-eventType-EventDate-index
      RoleARN: !GetAtt AutoScalingDynamoDBRole.Arn
      ScalableDimension: "dynamodb:index:ReadCapacityUnits"
      ServiceNamespace: dynamodb

  EventTableUserIDEventCategoryEventTypeEventDateIndexReadScalingPolicy:
    Type: "AWS::ApplicationAutoScaling::ScalingPolicy"
    Properties:
      PolicyName: EventTableUserIDEventCategoryEventTypeEventDateIndexReadScalingPolicy
      PolicyType: TargetTrackingScaling
      ScalingTargetId:
        Ref: EventTableUserIDEventCategoryEventTypeEventDateIndexReadCapacityScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: 40
        ScaleInCooldown: 60
        ScaleOutCooldown: 60
        PredefinedMetricSpecification:
          PredefinedMetricType: DynamoDBReadCapacityUtilization

  EventTableUserIDEventCategoryZoneIDEventDateIndexWriteCapacityScalableTarget:
    Type: "AWS::ApplicationAutoScaling::ScalableTarget"
    Properties:
      MaxCapacity: 10000
      MinCapacity: 10
      ResourceId:
        "Fn::Join":
          - "/"
          - - table
            - Ref: EventTable
            - index
            - userID-eventCategory-zoneID-GSI
      RoleARN: !GetAtt AutoScalingDynamoDBRole.Arn
      ScalableDimension: "dynamodb:index:WriteCapacityUnits"
      ServiceNamespace: dynamodb

  EventTableUserIDEventCategoryZoneIDEventDateIndexWriteScalingPolicy:
    Type: "AWS::ApplicationAutoScaling::ScalingPolicy"
    Properties:
      PolicyName: EventTableUserIDEventCategoryZoneIDEventDateIndexWriteScalingPolicy
      PolicyType: TargetTrackingScaling
      ScalingTargetId:
        Ref: EventTableUserIDEventCategoryZoneIDEventDateIndexWriteCapacityScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: 40
        ScaleInCooldown: 60
        ScaleOutCooldown: 60
        PredefinedMetricSpecification:
          PredefinedMetricType: DynamoDBWriteCapacityUtilization

  EventTableUserIDEventCategoryZoneIDEventDateIndexReadCapacityScalableTarget:
    Type: "AWS::ApplicationAutoScaling::ScalableTarget"
    Properties:
      MaxCapacity: 10000
      MinCapacity: 50
      ResourceId:
        "Fn::Join":
          - "/"
          - - table
            - Ref: EventTable
            - index
            - userID-eventCategory-zoneID-GSI
      RoleARN: !GetAtt AutoScalingDynamoDBRole.Arn
      ScalableDimension: "dynamodb:index:ReadCapacityUnits"
      ServiceNamespace: dynamodb

  EventTableUserIDEventCategoryPersonIDEventDateIndexReadScalingPolicy:
    Type: "AWS::ApplicationAutoScaling::ScalingPolicy"
    Properties:
      PolicyName: EventTableUserIDEventCategoryZoneIDEventDateIndexReadScalingPolicy
      PolicyType: TargetTrackingScaling
      ScalingTargetId:
        Ref: EventTableUserIDEventCategoryZoneIDEventDateIndexReadCapacityScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: 40
        ScaleInCooldown: 60
        ScaleOutCooldown: 60
        PredefinedMetricSpecification:
          PredefinedMetricType: DynamoDBReadCapacityUtilization

  EventTableUserIDEventCategoryPersonIDEventDateIndexWriteCapacityScalableTarget:
    Type: "AWS::ApplicationAutoScaling::ScalableTarget"
    Properties:
      MaxCapacity: 10000
      MinCapacity: 10
      ResourceId:
        "Fn::Join":
          - "/"
          - - table
            - Ref: EventTable
            - index
            - userID-eventCategory-personID-GSI
      RoleARN: !GetAtt AutoScalingDynamoDBRole.Arn
      ScalableDimension: "dynamodb:index:WriteCapacityUnits"
      ServiceNamespace: dynamodb

  EventTableUserIDEventCategoryPersonIDEventDateIndexWriteScalingPolicy:
    Type: "AWS::ApplicationAutoScaling::ScalingPolicy"
    Properties:
      PolicyName: EventTableUserIDEventCategoryPersonIDEventDateIndexWriteScalingPolicy
      PolicyType: TargetTrackingScaling
      ScalingTargetId:
        Ref: EventTableUserIDEventCategoryPersonIDEventDateIndexWriteCapacityScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: 40
        ScaleInCooldown: 60
        ScaleOutCooldown: 60
        PredefinedMetricSpecification:
          PredefinedMetricType: DynamoDBWriteCapacityUtilization

  EventTableUserIDEventCategoryPersonIDEventDateIndexReadCapacityScalableTarget:
    Type: "AWS::ApplicationAutoScaling::ScalableTarget"
    Properties:
      MaxCapacity: 10000
      MinCapacity: 50
      ResourceId:
        "Fn::Join":
          - "/"
          - - table
            - Ref: EventTable
            - index
            - userID-eventCategory-personID-GSI
      RoleARN: !GetAtt AutoScalingDynamoDBRole.Arn
      ScalableDimension: "dynamodb:index:ReadCapacityUnits"
      ServiceNamespace: dynamodb

  EventTableUserIDEventCategoryPersonIDEventDateIndexReadScalingPolicy:
    Type: "AWS::ApplicationAutoScaling::ScalingPolicy"
    Properties:
      PolicyName: EventTableUserIDEventCategoryZoneIDEventDateIndexReadScalingPolicy
      PolicyType: TargetTrackingScaling
      ScalingTargetId:
        Ref: EventTableUserIDEventCategoryPersonIDEventDateIndexReadCapacityScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: 40
        ScaleInCooldown: 60
        ScaleOutCooldown: 60
        PredefinedMetricSpecification:
          PredefinedMetricType: DynamoDBReadCapacityUtilization

  AutoScalingDynamoDBRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - application-autoscaling.amazonaws.com
            Action:
              - 'sts:AssumeRole'
      Path: /
      Policies:
        - PolicyName: ScalingDynamoDB
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - 'dynamodb:DescribeTable'
                  - 'dynamodb:UpdateTable'
                  - 'cloudwatch:PutMetricAlarm'
                  - 'cloudwatch:DescribeAlarms'
                  - 'cloudwatch:GetMetricStatistics'
                  - 'cloudwatch:SetAlarmState'
                  - 'cloudwatch:DeleteAlarms'
                Resource: '*'

  EventsConfigTable:
    Type: 'AWS::DynamoDB::Table'
    Properties:
      TableName: !Join
        - ''
        - - EventsConfig-
          - !Ref RealmName
      AttributeDefinitions:
        - AttributeName: EventType
          AttributeType: S
      KeySchema:
        - AttributeName: EventType
          KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: '5'
        WriteCapacityUnits: '5'
Parameters:
  InstanceName:
    Default: dev
    Description: The name of this instance
    Type: String
    MinLength: '2'
    MaxLength: '16'
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9][a-zA-Z0-9]*'
    ConstraintDescription: >-
      must begin with a letter, at least two characters, and contain only alphanumeric characters.
  Version:
    Description: stack version.
    Type: String
  LambdaCodeS3Bucket:
    Description: The S3 Bucket of lambda code
    Type: String
  LambdaCodeS3Key:
    Description: The S3 Key of lambda code
    Type: String
  RealmName:
    Description: target data realm.
    Type: String
  PythonRuntime:
    Description: Python runtime
    Type: String
    Default: python3.8
  CloudFrontKeyPairID:
    Description: CloudFront Key Pair ID
    Type: String
  CloudFrontKeyPairBucket:
    Description: CloudFront Key Pair Bucket
    Type: String
  CloudFrontKeyPairFileKey:
    Description: CloudFront Key Pair File Key
    Type: String
